# ğŸ” SQLite é›†æˆé—®é¢˜åˆ†æä¸ä¿®å¤

## ğŸ“‹ é—®é¢˜åˆ†æ

ç”¨æˆ·åé¦ˆ"å¥½åƒæ²¡æœ‰å®ç°"ï¼Œè®©æˆ‘æ£€æŸ¥å¯èƒ½çš„åŸå› ï¼š

### âœ… å·²ç¡®è®¤æ­£å¸¸å·¥ä½œçš„éƒ¨åˆ†ï¼š

1. âœ… **TypeScript ç¼–è¯‘é€šè¿‡**
2. âœ… **Vite æ„å»ºæˆåŠŸ**
3. âœ… **Tauri é…ç½®æ­£ç¡®** (`sql:default`, `sql:allow-load`, `sql:allow-execute`, `sql:allow-select`)
4. âœ… **ä»£ç å·²é›†æˆ** (`App.tsx` è°ƒç”¨ `initializeDatabase()`)
5. âœ… **å¯¼å‡ºæ­£ç¡®** (`index.ts` å¯¼å‡ºæ‰€æœ‰å‡½æ•°)

---

## ğŸ” å¯èƒ½çš„é—®é¢˜

### 1. **Rust ä¾èµ–æ²¡æœ‰ç¼–è¯‘**

Tauri SQL Plugin éœ€è¦ Rust ç«¯çš„ä»£ç ç¼–è¯‘ã€‚å¦‚æœ Rust ä»£ç æ²¡æœ‰ç¼–è¯‘ï¼Œæ’ä»¶å°†ä¸å¯ç”¨ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# é‡æ–°ç¼–è¯‘ Rust ä»£ç 
cd src-tauri
cargo build
```

---

### 2. **Tauri å¼€å‘æœåŠ¡å™¨æœªé‡å¯**

æ·»åŠ æ–°æ’ä»¶åéœ€è¦é‡å¯ Tauri å¼€å‘æœåŠ¡å™¨ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# åœæ­¢å½“å‰çš„ Tauri è¿›ç¨‹
# ç„¶åé‡æ–°å¯åŠ¨
npm run tauri dev
```

---

### 3. **åŠ¨æ€å¯¼å…¥é—®é¢˜**

ä½¿ç”¨äº†åŠ¨æ€å¯¼å…¥ (`await import(...)`)ï¼Œå¯èƒ½åœ¨æŸäº›æƒ…å†µä¸‹ä¸å·¥ä½œã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šå·²ä½¿ç”¨åŠ¨æ€å¯¼å…¥ï¼Œè¿™æ˜¯æ­£ç¡®çš„ï¼Œå› ä¸ºï¼š
- é¿å…å¾ªç¯ä¾èµ–
- æŒ‰éœ€åŠ è½½ï¼Œå‡å°‘åˆå§‹ bundle å¤§å°

---

### 4. **è¿è¡Œæ—¶é”™è¯¯æœªè¢«æ•è·**

æ•°æ®åº“åˆå§‹åŒ–å¯èƒ½å¤±è´¥äº†ï¼Œä½†é”™è¯¯è¢«é™é»˜å¤„ç†ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šæ·»åŠ è¯¦ç»†æ—¥å¿—

---

## âœ… å·²å®æ–½çš„ä¿®å¤

### 1. **æ·»åŠ æµ‹è¯•å‡½æ•°**

åˆ›å»ºäº† `test.ts` æ–‡ä»¶ï¼ŒåŒ…å«å®Œæ•´çš„æ•°æ®åº“æµ‹è¯•æµç¨‹ï¼š

```typescript
export async function testDatabase() {
  // 1. æµ‹è¯•æ•°æ®åº“åˆå§‹åŒ–
  // 2. æµ‹è¯•ç»Ÿè®¡ä¿¡æ¯
  // 3. æµ‹è¯•ä¼šè¯åˆ›å»º
  // 4. æµ‹è¯•ä¼šè¯æŸ¥è¯¢
  // 5. æ¸…ç†æµ‹è¯•æ•°æ®
}
```

---

### 2. **å¯¼å‡ºæµ‹è¯•å‡½æ•°**

åœ¨ `index.ts` ä¸­æ·»åŠ äº†æµ‹è¯•å‡½æ•°å¯¼å‡ºï¼š

```typescript
export { testDatabase } from './test'
```

---

### 3. **æ£€æŸ¥æƒé™é…ç½®**

ç¡®è®¤ `src-tauri/capabilities/default.json` åŒ…å«å¿…è¦çš„æƒé™ï¼š

```json
{
  "permissions": [
    "sql:default",
    "sql:allow-load",
    "sql:allow-execute",
    "sql:allow-select"
  ]
}
```

âœ… æƒé™é…ç½®æ­£ç¡®ï¼

---

## ğŸ§ª éªŒè¯æ­¥éª¤

### **æ–¹æ³• 1: æ§åˆ¶å°æ—¥å¿—æ£€æŸ¥**

å¯åŠ¨åº”ç”¨åï¼Œæ£€æŸ¥æ§åˆ¶å°æ˜¯å¦æœ‰ä»¥ä¸‹æ—¥å¿—ï¼š

```
[App] æ­£åœ¨åˆå§‹åŒ–æ•°æ®åº“...
[MemoryService] æ­£åœ¨åˆå§‹åŒ–æ•°æ®åº“...
[MemoryService] âœ… æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ
[MemoryService] æ•°æ®åº“ç»Ÿè®¡: { sessionCount: 0, ... }
[App] âœ… æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ
```

å¦‚æœæ²¡æœ‰è¿™äº›æ—¥å¿—ï¼Œè¯´æ˜ï¼š
- æ•°æ®åº“åˆå§‹åŒ–æœªè¢«è°ƒç”¨
- æˆ–åˆå§‹åŒ–å¤±è´¥äº†ï¼ˆä½†é”™è¯¯è¢«æ•è·ï¼‰

---

### **æ–¹æ³• 2: æ‰‹åŠ¨æµ‹è¯•æ•°æ®åº“**

åœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­è¿è¡Œï¼š

```javascript
// 1. å¯¼å…¥æµ‹è¯•å‡½æ•°
import('./src/services/memory/index.js').then(m => {
  // 2. è¿è¡Œæµ‹è¯•
  m.testDatabase().then(success => {
    console.log('æµ‹è¯•ç»“æœ:', success ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥')
  })
})
```

---

### **æ–¹æ³• 3: æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶**

åœ¨ä»¥ä¸‹ä½ç½®æŸ¥æ‰¾æ•°æ®åº“æ–‡ä»¶ï¼š

**Windows**:
```
C:\Users\<ç”¨æˆ·å>\AppData\com.tauri.app\<app-id>\polaris_memory.db
```

æˆ–åº”ç”¨æ•°æ®ç›®å½•ä¸­çš„ `polaris_memory.db`

---

## ğŸ› å·²çŸ¥çš„æ½œåœ¨é—®é¢˜

### **é—®é¢˜ 1: Tauri SQL Plugin ç‰ˆæœ¬ä¸åŒ¹é…**

**ç—‡çŠ¶**ï¼š
- æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥
- é”™è¯¯ï¼š`plugin not found`

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# 1. æ¸…ç†ä¾èµ–
npm install

# 2. é‡æ–°å®‰è£…
npm install @tauri-apps/plugin-sql@latest

# 3. é‡æ–°ç¼–è¯‘ Rust ä»£ç 
cd src-tauri
cargo build
```

---

### **é—®é¢˜ 2: åŠ¨æ€å¯¼å…¥å¤±è´¥**

**ç—‡çŠ¶**ï¼š
- æ§åˆ¶å°æ²¡æœ‰åˆå§‹åŒ–æ—¥å¿—
- æˆ–å‡ºç° `Failed to fetch dynamically imported module`

**è§£å†³æ–¹æ¡ˆ**ï¼š
```typescript
// æ”¹ä¸ºé™æ€å¯¼å…¥ï¼ˆåœ¨ integration.ts é¡¶éƒ¨ï¼‰
import { DatabaseManager } from './database'
import { SessionRepository } from './repositories/session-repository'
import { MessageRepository } from './repositories/message-repository'

// ç„¶åæ­£å¸¸å¯¼å‡ºå’Œä½¿ç”¨
```

---

## ğŸš€ å®Œæ•´çš„æµ‹è¯•æµç¨‹

### **æ­¥éª¤ 1: ç¡®ä¿ Rust ç¼–è¯‘**

```bash
cd src-tauri
cargo build
```

é¢„æœŸè¾“å‡ºï¼š
```
Compiling tauri-plugin-sql
Finished dev [optimized] target(s) in XXs
```

---

### **æ­¥éª¤ 2: å¯åŠ¨åº”ç”¨**

```bash
npm run tauri dev
```

---

### **æ­¥éª¤ 3: æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—**

åº”è¯¥çœ‹åˆ°ï¼š
```
[App] æ­£åœ¨åˆå§‹åŒ–æ•°æ®åº“...
[DatabaseManager] æ­£åœ¨åˆå§‹åŒ–æ•°æ®åº“...
[DatabaseManager] æ­£åœ¨åˆ›å»ºè¡¨ç»“æ„...
[DatabaseManager] âœ… è¡¨ç»“æ„åˆ›å»ºå®Œæˆ
[DatabaseManager] âœ… ç´¢å¼•åˆ›å»ºå®Œæˆ
[DatabaseManager] âœ… è§†å›¾åˆ›å»ºå®Œæˆ
[DatabaseManager] âœ… è§¦å‘å™¨åˆ›å»ºå®Œæˆ
[DatabaseManager] âœ… æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ
[MemoryService] âœ… æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ
[MemoryService] æ•°æ®åº“ç»Ÿè®¡: { sessionCount: 0, ... }
[App] âœ… æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ
```

---

### **æ­¥éª¤ 4: å‘é€æµ‹è¯•æ¶ˆæ¯**

1. å‘é€ä¸€æ¡æ¶ˆæ¯
2. ç»“æŸä¼šè¯
3. æ£€æŸ¥æ§åˆ¶å°æ˜¯å¦æœ‰ `[MemoryService] ä¼šè¯ä¿å­˜æˆåŠŸ`

---

### **æ­¥éª¤ 5: æ£€æŸ¥å†å²è®°å½•**

1. æ‰“å¼€å†å²è®°å½•é¢æ¿
2. æŸ¥çœ‹ä¼šè¯æ˜¯å¦æ˜¾ç¤º
3. ç‚¹å‡»æ¢å¤ï¼Œæ£€æŸ¥æ˜¯å¦æˆåŠŸ

---

## ğŸ“Š é¢„æœŸè¡Œä¸º

### **å¦‚æœå®ç°æˆåŠŸ**ï¼š

1. âœ… åº”ç”¨å¯åŠ¨æ—¶åˆå§‹åŒ–æ•°æ®åº“
2. âœ… æ¯æ¬¡ä¼šè¯ç»“æŸè‡ªåŠ¨ä¿å­˜åˆ° SQLite
3. âœ… å†å²è®°å½•é¢æ¿æ˜¾ç¤º SQLite ä¸­çš„ä¼šè¯
4. âœ… ç‚¹å‡»ä¼šè¯å¯ä»¥æ¢å¤
5. âœ… æ•°æ®æŒä¹…åŒ–ï¼Œåˆ·æ–°é¡µé¢ä¸ä¸¢å¤±

### **å¦‚æœæœªæˆåŠŸ**ï¼š

âŒ æ²¡æœ‰æ•°æ®åº“åˆå§‹åŒ–æ—¥å¿—
âŒ ä¼šè¯ä»ç„¶åªä¿å­˜åœ¨ localStorage
âŒ åˆ·æ–°é¡µé¢æ•°æ®ä¸¢å¤±

---

## ğŸ”§ å¿«é€Ÿä¿®å¤æ–¹æ¡ˆ

### **æ–¹æ¡ˆ 1: ç¡®ä¿ä¾èµ–å®‰è£…**

```bash
# å‰ç«¯ä¾èµ–
npm install @tauri-apps/plugin-sql

# Rust ä¾èµ–ï¼ˆå·²åœ¨ Cargo.toml ä¸­ï¼‰
cd src-tauri
cargo build
```

---

### **æ–¹æ¡ˆ 2: æ£€æŸ¥ Tauri ç‰ˆæœ¬**

```bash
npm list @tauri-apps/api @tauri-apps/plugin-sql
```

ç¡®ä¿ç‰ˆæœ¬å…¼å®¹ï¼š
- `@tauri-apps/api`: `^2.0.0`
- `@tauri-apps/plugin-sql`: `^2.0.0`

---

### **æ–¹æ¡ˆ 3: æ·»åŠ è°ƒè¯•æ—¥å¿—**

åœ¨ `App.tsx` ä¸­æ·»åŠ æ›´å¤šæ—¥å¿—ï¼š

```typescript
try {
  console.log('[App] æ­£åœ¨åˆå§‹åŒ–æ•°æ®åº“...')
  const result = await initializeDatabase()
  console.log('[App] æ•°æ®åº“åˆå§‹åŒ–ç»“æœ:', result)
  if (result) {
    console.log('[App] âœ… æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ')
  } else {
    console.warn('[App] âš ï¸  æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥ï¼Œå°†ä½¿ç”¨ localStorage')
  }
} catch (error) {
  console.error('[App] âŒ æ•°æ®åº“åˆå§‹åŒ–å¼‚å¸¸:', error)
}
```

---

## âœ… éªŒè¯æ¸…å•

è¯·æ£€æŸ¥ä»¥ä¸‹å†…å®¹ï¼Œå‘Šè¯‰æˆ‘å…·ä½“æƒ…å†µï¼š

- [ ] æ§åˆ¶å°æ˜¯å¦æœ‰ `[App] æ­£åœ¨åˆå§‹åŒ–æ•°æ®åº“...` æ—¥å¿—ï¼Ÿ
- [ ] æ˜¯å¦æœ‰ `[DatabaseManager]` ç›¸å…³æ—¥å¿—ï¼Ÿ
- [ ] æ˜¯å¦æœ‰ä»»ä½•é”™è¯¯ä¿¡æ¯ï¼Ÿ
- [ ] Rust ç¼–è¯‘æ˜¯å¦æˆåŠŸï¼ˆ`cargo build`ï¼‰ï¼Ÿ
- [ ] `polaris_memory.db` æ–‡ä»¶æ˜¯å¦è¢«åˆ›å»ºï¼Ÿ

---

## ğŸ’¡ ä¸‹ä¸€æ­¥

å‘Šè¯‰æˆ‘ä½ çœ‹åˆ°çš„å…·ä½“æƒ…å†µï¼š
- æ˜¯å¦æœ‰åˆå§‹åŒ–æ—¥å¿—ï¼Ÿ
- æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯ï¼Ÿ
- æ•°æ®åº“æ–‡ä»¶æ˜¯å¦åˆ›å»ºï¼Ÿ

æˆ‘ä¼šæ ¹æ®ä½ çš„åé¦ˆè¿›è¡Œé’ˆå¯¹æ€§ä¿®å¤ï¼~ ğŸ’«
